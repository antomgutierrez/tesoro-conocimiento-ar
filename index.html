<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>AR.js + A-Frame - Escena BÃ¡sica</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.2/aframe/build/aframe-ar-nft.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <style>
      body { margin: 0; overflow: hidden; }
      #loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 20px;
        border-radius: 10px;
        z-index: 1000;
        text-align: center;
      }
      #error {
        position: fixed;
        top: 10px;
        left: 10px;
        right: 10px;
        background: rgba(255,0,0,0.8);
        color: white;
        padding: 10px;
        border-radius: 5px;
        z-index: 1000;
        display: none;
      }
    </style>
  </head>

  <body>
    <div id="loading">Cargando experiencia AR...</div>
    <div id="error"></div>
    <div id="status" style="position: fixed; bottom: 10px; left: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 5px; z-index: 1000; text-align: center; display: none;">Apunta la cÃ¡mara al marcador</div>
    <div id="progress" style="position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 10px; border-radius: 5px; z-index: 1000; font-family: monospace;"></div>

    <audio id="sound-found" src="sounds/found.mp3" preload="auto"></audio>
    <audio id="sound-win" src="sounds/win.mp3" preload="auto"></audio>
    <audio id="sound-wrong" src="sounds/wrong.mp3" preload="auto"></audio>
    
    <!-- La escena AR -->
    <a-scene embedded arjs="sourceType: webcam; detectionMode: mono_and_matrix; matrixCodeType: 3x3; markersAreaEnabled: true;">
      
      <a-entity light="type: ambient; intensity: 0.8"></a-entity>
      <a-entity light="type: directional; intensity: 0.6" position="1 1 0"></a-entity>

      <a-marker type="pattern" url="markers/recepcion.patt" id="marker-recepcion">
        <a-entity look-at="[camera]">
          <a-entity
            gltf-model="url(modelos/pista_aula_magna.glb)"
            rotation="-90 0 0"
            position="0 0 0"
            animation="property: scale; to: 0.5 0.5 0.5; from: 0.1 0.1 0.1; dur: 700; easing: easeOutCubic; startEvents: markerFoundAnimation">
          </a-entity>
        </a-entity>
        <a-entity look-at="[camera]">
          <a-text 
            value="La busqueda comienza donde se oculta la formula de la felicidad" 
            rotation="-90 0 0"
            color="#4a2c2a"
            position="0 0 -4"
            scale="1 1 1">
          </a-text>
        </a-entity>
      </a-marker>

      <!-- Marcador 2 (aula magna) -->
      <a-marker type="pattern" url="markers/aula_magna.patt" id="aula_magna">
        <a-entity look-at="[camera]">
          <a-entity
            gltf-model="url(modelos/pista_patio.glb)"
            rotation="0 270 90"
            position="0 0 0"
            animation="property: scale; to: 0.5 0.5 0.5; from: 0.1 0.1 0.1; dur: 700; easing: easeOutCubic; startEvents: markerFoundAnimation">
          </a-entity>
        </a-entity>
        <a-entity look-at="[camera]">
          <a-text 
            value="Despues del esfuerzo, \n el alma necesita respiro entre el verde" 
            rotation="-90 0 0"
            color="#4a2c2a"
            position="4 0 -4"
            scale="1 1 1">
          </a-text>
        </a-entity>
      </a-marker>

      <!-- Marcador 3 (patio) -->
      <a-marker type="pattern" url="markers/patio.patt" id="patio">
        <a-entity look-at="[camera]">
          <a-entity
            gltf-model="url(modelos/pista_cantina.glb)"
            rotation="-90 0 0"
            position="0 0 0"
            animation="property: scale; to: 1 1 1; from: 0.5 0.5 0.5; dur: 700; easing: easeOutCubic; startEvents: markerFoundAnimation">
          </a-entity>
        </a-entity>
        <a-entity look-at="[camera]">
          <a-text 
            value="Hasta el sabio necesita energia. \nDisfruta del sabor del descanso. \nEl tesoro esta cerca..." 
            rotation="-90 0 0"
            color="#4a2c2a"
            position="0 0 -4"
            scale="1 1 1">
          </a-text>
        </a-entity>
      </a-marker>

      <!-- Marcador 4 (cantina) -->
      <a-marker type="pattern" url="markers/cantina.patt" id="cantina">
        <a-entity look-at="[camera]">
          <a-entity
            gltf-model="url(modelos/pista_biblioteca.glb)"
            rotation="-90 0 0"
            position="0 0 3"
            animation="property: scale; to: 0.5 0.5 0.5; from: 0.1 0.1 0.1; dur: 700; easing: easeOutCubic; startEvents: markerFoundAnimation">
          </a-entity>
        </a-entity>
        <a-entity look-at="[camera]">
          <a-text 
            value="Entre paginas y silencios, \nduerme el mayor de los tesoros. \nSolo quien ha recorrido el camino del conocimiento podra despertarlo" 
            rotation="-90 0 0"
            color="#4a2c2a"
            position="-2 0 -4"
            scale="1 1 1">
          </a-text>
        </a-entity>
      </a-marker>

      <!-- Marcador 5 (meta del mapa) -->
      <a-marker type="pattern" url="markers/meta.patt" id="marker-tesoro">
        <a-entity look-at="[camera]">
          <a-entity
            gltf-model="url(modelos/tesoro.glb)"
            rotation="45 -180 0"
            position="0 0 0"
            animation="property: scale; to: 10 10 10; from: 0.1 0.1 0.1; dur: 700; easing: easeOutCubic; startEvents: markerFoundAnimation">
          </a-entity>
        </a-entity>
        <a-entity look-at="[camera]">
          <a-text 
            value="Â¡TESORO ENCONTRADO!" 
            rotation="-90 0 0"
            color="#4a2c2a"
            position="-2 0 -2"
            scale="1 1 1">
          </a-text>
        </a-entity>
      </a-marker>

      <!-- CÃ¡mara AR -->
      <a-entity camera></a-entity>

    </a-scene>

    <script>
      window.addEventListener('load', () => {
        const scene = document.querySelector('a-scene');
        const loadingEl = document.getElementById('loading');
        const statusEl = document.getElementById('status');
        const progressEl = document.getElementById('progress');

        const soundFound = document.getElementById('sound-found');
        const soundWin = document.getElementById('sound-win');
        const soundWrong = document.getElementById('sound-wrong');

        const sequence = ['marker-recepcion', 'aula_magna', 'patio', 'cantina', 'marker-tesoro'];
        let currentStep = 0;
        const foundMarkers = new Set();

        function showStatus(text, color = 'rgba(0,0,0,0.8)', duration = 3000) {
            statusEl.textContent = text;
            statusEl.style.background = color;
            statusEl.style.display = 'block';
            setTimeout(() => { statusEl.style.display = 'none'; }, duration);
        }

        function updateProgress() {
            progressEl.textContent = `Pistas: ${foundMarkers.size} / ${sequence.length}`;
        }

        function setupMarkers() {
            sequence.forEach((markerId, index) => {
                const marker = document.getElementById(markerId);
                if (!marker) {
                    console.warn(`Marcador no encontrado: ${markerId}`);
                    return;
                }

                const model = marker.querySelector('a-entity[gltf-model]');
                const text = marker.querySelector('a-text');
                
                // Ocultar modelo y texto al inicio
                model.setAttribute('visible', false);
                text.setAttribute('visible', false);

                marker.addEventListener('markerFound', () => {
                    if (index > currentStep) {
                        showStatus('ðŸ”’ AÃºn no es momento de explorar esta Ã¡rea.', 'rgba(200,0,0,0.8)');
                        soundWrong.play();
                        // Asegurarse de que todo estÃ© oculto si la secuencia es incorrecta
                        model.setAttribute('visible', false);
                        text.setAttribute('visible', false);
                        return;
                    }

                    // Mostrar modelo y texto
                    model.setAttribute('visible', true);
                    text.setAttribute('visible', true);
                    model.emit('markerFoundAnimation'); // Iniciar animaciÃ³n

                    if (foundMarkers.has(markerId)) return;

                    foundMarkers.add(markerId);
                    currentStep++;
                    updateProgress();

                    if (foundMarkers.size === sequence.length) {
                        showStatus('ðŸ† Â¡Has encontrado el Tesoro del Conocimiento!', 'rgba(255,215,0,0.9)');
                        soundWin.play();
                    } else {
                        showStatus('âœ… Â¡Pista encontrada! ContinÃºa la bÃºsqueda...', 'rgba(0,150,0,0.9)');
                        soundFound.play();
                    }
                });

                marker.addEventListener('markerLost', () => {
                    // Ocultar modelo y texto al perder el marcador
                    model.setAttribute('visible', false);
                    text.setAttribute('visible', false);
                });
            });
        }

        scene.addEventListener('loaded', () => {
            setupMarkers();
            updateProgress();
            showStatus('ðŸŽ¯ Haz click en la pantalla, luego, escanea el primer marcador para comenzar...');
            loadingEl.style.display = 'none';
        });
      });
    </script>
    
  
  </body>
</html>
